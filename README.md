# SAP BTP Usage MCP Server

An **MCP (Model Context Protocol) server** that exposes SAP BTP resource consumption data as tools for AI assistants. Deploy it to Cloud Foundry and connect it to **SAP Joule Studio** so that users can ask natural language questions about BTP costs and usage.

---

## What it does

This server bridges the [SAP BTP Usage Data Management API](https://api.sap.com/package/SAPBTPResourceConsumption) with any MCP-compatible AI client. Once deployed, you can ask questions like:

- _"How many cloud credits do we have left?"_
- _"Compare our BTP consumption for the last two months"_
- _"Which services are exceeding their quota?"_
- _"What new services did we enable recently?"_

---

## Architecture

```
┌─────────────────┐     MCP (HTTP)      ┌──────────────────────┐     OAuth2      ┌──────────────────┐
│  SAP Joule      │ ──────────────────► │  MCP Server (CF App) │ ─────────────► │  SAP BTP Usage   │
│  Studio         │   Bearer Token      │  Node.js / Express   │   via Dest.     │  API (eu10)      │
└─────────────────┘                     └──────────────────────┘                 └──────────────────┘
        │                                         │
        │  OAuth2 (client_credentials)            │ validates JWT
        ▼                                         ▼
┌─────────────────┐                     ┌──────────────────────┐
│  BTP Destination│                     │  XSUAA               │
│  (MCP_UAS)      │                     │  (movetosap-dev)     │
└─────────────────┘                     └──────────────────────┘
```

**Flow:**
1. Joule Studio reads the `MCP_UAS` BTP Destination (type `HTTP`, auth `OAuth2ClientCredentials`)
2. The Destination Service obtains a JWT from XSUAA using the configured client credentials
3. Joule sends `POST /mcp` with that Bearer token
4. The MCP server validates the JWT (signature, issuer, audience) via the XSUAA middleware
5. The MCP tool executes and calls the SAP BTP Usage API via a second BTP Destination

---

## Project structure

```
sap-btp-usage-mcp-server/
├── src/
│   ├── auth/
│   │   ├── auth-middleware.ts   # Express middleware: validates Bearer JWT
│   │   ├── jwt-validator.ts     # JWT verification with RS256 + audience check
│   │   └── xsuaa-config.ts     # Loads XSUAA credentials from VCAP_SERVICES
│   ├── schemas/
│   │   └── input-schemas.ts    # Zod schemas for each tool's input parameters
│   ├── services/
│   │   └── sap-api-client.ts   # HTTP client for the SAP BTP Usage API
│   ├── sse/
│   │   └── sse-handler.ts      # Server-Sent Events handler (alternative transport)
│   ├── tools/
│   │   └── usage-tools.ts      # MCP tool definitions (6 tools)
│   ├── index.ts                # Express app + MCP server bootstrap
│   └── types.ts                # TypeScript types for API responses
├── dist/                       # Compiled JavaScript (generated by `npm run build`)
├── manifest.yaml               # Cloud Foundry deployment manifest
├── xs-security.json            # XSUAA service configuration
├── package.json
├── tsconfig.json
└── default-env.json            # Local credentials — never commit this file
```

---

## Available MCP tools

| Tool name | Description |
|---|---|
| `sap_btp_get_cloud_credits` | Current cloud credits balance, contract phases and expiry date |
| `sap_btp_top_services` | Top N services by cost or usage in a given period |
| `sap_btp_compare_months` | Month-over-month consumption trend with % change |
| `sap_btp_check_overusage` | Services exceeding quota with PAYG extra costs |
| `sap_btp_new_services` | Services enabled in recent months (not present before) |
| `sap_btp_cost_summary` | Total cost grouped by service, subaccount, or datacenter |

---

## Prerequisites

- **Node.js** ≥ 18
- **Cloud Foundry CLI** (`cf`)
- An **SAP BTP account** with:
  - Access to the [SAP BTP Usage Data Management API](https://api.sap.com/package/SAPBTPResourceConsumption)
  - Permission to create XSUAA and Destination service instances
  - SAP Joule Studio enabled (for the AI integration)

---

## 1. Create the XSUAA service instance

The `xs-security.json` defines the OAuth2 configuration for this server.

```bash
cf create-service xsuaa application sap-btp-usage-xsuaa -c xs-security.json
```

After creation, note the `clientid`, `clientsecret`, and `url` from the service key:

```bash
cf create-service-key sap-btp-usage-xsuaa my-key
cf service-key sap-btp-usage-xsuaa my-key
```

---

## 2. Create the Destination Service instance

```bash
cf create-service destination lite sap-btp-usage-destination
```

Then configure a Destination in the **BTP Cockpit** pointing to the SAP BTP Usage API:

| Field | Value |
|---|---|
| Name | `SAP_BTP_USAGE_API` |
| Type | `HTTP` |
| URL | `https://uas-reporting.cfapps.eu10.hana.ondemand.com` |
| Authentication | `OAuth2ClientCredentials` |
| Client ID | _(from the UAS service key)_ |
| Client Secret | _(from the UAS service key)_ |
| Token Service URL | `https://<tenant>.authentication.eu10.hana.ondemand.com/oauth/token` |

> The app resolves this destination at runtime via the Destination Service. No credentials are stored in the app.

---

## 3. Deploy to Cloud Foundry

```bash
npm run build
cf push
```

The `manifest.yaml` binds the app to both `sap-btp-usage-xsuaa` and `sap-btp-usage-destination` automatically.

Verify the deployment:

```bash
cf app sap-btp-usage-mcp-server
curl https://<your-app-url>/health
```

Expected response: `{"status":"healthy","server":"sap-btp-usage-mcp-server"}`

---

## 4. Connect to SAP Joule Studio

In the **subaccount where Joule Studio is enabled**, create a Destination pointing to this MCP server. You can import the following JSON directly in the BTP Cockpit:

```json
{
  "destination": {
    "Name": "MCP_UAS",
    "Type": "HTTP",
    "URL": "https://<your-app-url>",
    "ProxyType": "Internet",
    "Authentication": "OAuth2ClientCredentials",
    "clientId": "sb-sap-btp-usage-mcp-server!t<N>",
    "clientSecret": "<clientsecret from XSUAA service key>",
    "tokenServiceURL": "https://<tenant>.authentication.<region>.hana.ondemand.com/oauth/token",
    "tokenServiceURLType": "Dedicated",
    "sap-joule-studio-mcp-server": "true"
  }
}
```

Get `clientId`, `clientSecret` and `tokenServiceURL` from the XSUAA service key:

```bash
cf service-key sap-btp-usage-xsuaa my-key
```

> The `sap-joule-studio-mcp-server: true` additional property is required for Joule Studio to discover and register this server as an MCP toolkit.

---

## Local development

Create a `default-env.json` with credentials from your CF service keys (never commit this file):

```bash
# Get the values from your CF service keys
cf create-service-key sap-btp-usage-xsuaa local-key
cf service-key sap-btp-usage-xsuaa local-key

cf create-service-key sap-btp-usage-destination local-key
cf service-key sap-btp-usage-destination local-key
```

```json
// default-env.json  (never commit this file)
{
  "VCAP_SERVICES": {
    "xsuaa": [{
      "label": "xsuaa",
      "name": "sap-btp-usage-xsuaa",
      "credentials": {
        "clientid": "sb-sap-btp-usage-mcp-server!t<N>",
        "clientsecret": "<secret>",
        "url": "https://<tenant>.authentication.<region>.hana.ondemand.com",
        "uaadomain": "<tenant>.authentication.<region>.hana.ondemand.com",
        "xsappname": "sap-btp-usage-mcp-server!t<N>",
        "identityzone": "<tenant>",
        "verificationkey": "-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"
      }
    }],
    "destination": [{
      "label": "destination",
      "name": "sap-btp-usage-destination",
      "credentials": {
        "clientid": "<clientid from destination service key>",
        "clientsecret": "<clientsecret from destination service key>",
        "uri": "https://destination-configuration.cfapps.<region>.hana.ondemand.com",
        "url": "https://<tenant>.authentication.<region>.hana.ondemand.com"
      }
    }]
  }
}
```

> The app will use the Destination Service to fetch the `SAP_BTP_USAGE_API` destination configured in the BTP Cockpit.

Disable authentication locally (optional):

```bash
export AUTH_ENABLED=false
npm run local
```

The server starts on `http://localhost:3000`.

---

## API endpoints

| Endpoint | Method | Auth | Description |
|---|---|---|---|
| `/health` | GET | None | Health check (required by CF) |
| `/` | GET | None | Server info and active SSE sessions |
| `/mcp` | POST | Bearer JWT | Main MCP endpoint (Streamable HTTP) |
| `/mcp/sse` | GET | Bearer JWT | Alternative SSE transport |
| `/.well-known/oauth-authorization-server` | GET | None | OAuth2 metadata (RFC 8414) |

---

## Authentication details

The server uses XSUAA to validate every request to `/mcp` and `/mcp/sse`:

1. **Token extraction** — reads `Authorization: Bearer <token>` header
2. **Signature verification** — validates RS256 signature against the XSUAA public key
3. **Issuer check** — token `iss` must match the XSUAA URL
4. **Audience check** — token `aud` must contain `sap-btp-usage-mcp-server!t<N>` or `sb-sap-btp-usage-mcp-server!t<N>` (service broker client used by BTP Destinations)

Disable authentication by setting `AUTH_ENABLED=false` (development only).

---

## Dependencies

| Package | Purpose |
|---|---|
| `@modelcontextprotocol/sdk` | MCP server implementation |
| `express` | HTTP server |
| `@sap-cloud-sdk/http-client` | HTTP client with destination resolution |
| `@sap/xsenv` | Reads VCAP_SERVICES and default-env.json |
| `jsonwebtoken` | JWT verification |
| `zod` | Input schema validation |
